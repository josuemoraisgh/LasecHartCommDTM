name: Build Lasec HART Communication DTM

on:
  workflow_dispatch:
    inputs:
      version:
        description: "VersÃ£o (tag) ex.: v0.0.1"
        required: true
        type: string
      tag_repository:
        description: "Criar e enviar tag?"
        required: true
        default: true
        type: boolean
      publish_release:
        description: "Publicar Release?"
        required: true
        default: true
        type: boolean

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # ðŸ”¹ Restaurar projetos
      - name: Restore HartEngine
        run: dotnet restore src/HartEngine/HartEngine.csproj

      - name: Restore LasecHartCommDTM
        run: dotnet restore src/LasecHartCommDTM/LasecHartCommDTM.csproj

      # ðŸ”¹ Compilar (AGORA COM STRONG NAME)
      - name: Build HartEngine
        run: dotnet build src/HartEngine/HartEngine.csproj -c Release

      - name: Build LasecHartCommDTM
        run: dotnet build src/LasecHartCommDTM/LasecHartCommDTM.csproj -c Release

      # ðŸ”¹ Package DTM700 folder
      - name: Package DTM700 folder
        run: |
          mkdir artifacts
          mkdir artifacts\DTM700
          mkdir artifacts\DTM700\JosueLab
          mkdir artifacts\DTM700\JosueLab\LasecHartCommDTM
          mkdir artifacts\DTM700\JosueLab\LasecHartCommDTM\Dtm

          copy src\LasecHartCommDTM\bin\Release\net48\LasecHartCommDTM.dll artifacts\DTM700\JosueLab\LasecHartCommDTM\Dtm\
          copy src\HartEngine\bin\Release\net48\HartEngine.dll artifacts\DTM700\JosueLab\LasecHartCommDTM\Dtm\
          copy src\LasecHartCommDTM\packaging\DeviceTypeCatalog.xml artifacts\DTM700\JosueLab\LasecHartCommDTM\

      # ðŸ”¹ ZIP DTM700
      - name: Zip DTM700
        run: |
          Compress-Archive -Path artifacts\DTM700\* -DestinationPath artifacts\LasecHartCommDTM-DTM700-${{ github.event.inputs.version }}.zip

      # ðŸ”¹ Instalar WiX
      - name: Install WiX Toolset
        run: choco install wixtoolset --yes --no-progress

      # ðŸ”¹ Build MSI
      - name: Build MSI Installer
        run: |
          candle.exe installer\Product.wxs `
            -out installer\Product.wixobj `
            -dOutputDir=artifacts\DTM700\JosueLab\LasecHartCommDTM `
            -ext WixUIExtension

          light.exe installer\Product.wixobj `
            -out artifacts\LasecHartCommDTM-${{ github.event.inputs.version }}.msi `
            -ext WixUIExtension

      # ðŸ”¹ Upload artefatos
      - name: Upload DTM zip
        uses: actions/upload-artifact@v4
        with:
          name: LasecHartCommDTM-DTM700-${{ github.event.inputs.version }}
          path: artifacts\LasecHartCommDTM-DTM700-${{ github.event.inputs.version }}.zip

      - name: Upload MSI Installer
        uses: actions/upload-artifact@v4
        with:
          name: LasecHartCommDTM-${{ github.event.inputs.version }}.msi
          path: artifacts\LasecHartCommDTM-${{ github.event.inputs.version }}.msi

      # ðŸ”¹ Criar TAG
      - name: Create Git Tag
        if: ${{ github.event.inputs.tag_repository == 'true' }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag ${{ github.event.inputs.version }}
          git push origin ${{ github.event.inputs.version }}

      # ðŸ”¹ Criar Release
      - name: Publish Release
        if: ${{ github.event.inputs.publish_release == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: "Lasec HART Communication DTM ${{ github.event.inputs.version }}"
          body: |
            **Lasec HART Communication DTM**
            VersÃ£o: ${{ github.event.inputs.version }}

            Este release contÃ©m:
            - Pacote DTM700 pronto para PACTware
            - Instalador MSI que copia para a pasta certa e registra COM
          files: |
            artifacts/LasecHartCommDTM-DTM700-${{ github.event.inputs.version }}.zip
            artifacts/LasecHartCommDTM-${{ github.event.inputs.version }}.msi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}