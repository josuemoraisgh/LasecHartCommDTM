name: Build Lasec HART Communication DTM

on:
  workflow_dispatch:
    inputs:
      version:
        description: "VersÃ£o (tag) ex.: v0.0.1"
        required: true
        type: string
      tag_repository:
        description: "Criar e enviar tag?"
        default: true
        type: boolean
      publish_release:
        description: "Publicar Release?"
        default: true
        type: boolean

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # ðŸ”¹ Restaurar projetos
      - name: Restore HartEngine
        run: dotnet restore src/HartEngine/HartEngine.csproj

      - name: Restore LasecHartCommDTM
        run: dotnet restore src/LasecHartCommDTM/LasecHartCommDTM.csproj

      # ðŸ”¹ Compilar
      - name: Build HartEngine
        run: dotnet build src/HartEngine/HartEngine.csproj -c Release

      - name: Build LasecHartCommDTM
        run: dotnet build src/LasecHartCommDTM/LasecHartCommDTM.csproj -c Release

      # ðŸ”¹ Gerar artefato DTM700
      - name: Package DTM700 folder
        run: |
          mkdir artifacts
          mkdir artifacts\DTM700
          mkdir artifacts\DTM700\JosueLab
          mkdir artifacts\DTM700\JosueLab\LasecHartCommDTM
          mkdir artifacts\DTM700\JosueLab\LasecHartCommDTM\Dtm

          copy src\LasecHartCommDTM\bin\Release\LasecHartCommDTM.dll artifacts\DTM700\JosueLab\LasecHartCommDTM\Dtm\
          copy src\LasecHartCommDTM\packaging\DeviceTypeCatalog.xml artifacts\DTM700\JosueLab\LasecHartCommDTM\

      - name: Upload DTM artifact
        uses: actions/upload-artifact@v4
        with:
          name: LasecHartCommDTM-DTM700
          path: artifacts\DTM700

      # -----------------------------
      # ðŸ”¹ Criar TAG (se habilitado)
      # -----------------------------
      - name: Create Git Tag
        if: ${{ inputs.tag_repository == 'true' }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          
          git tag ${{ inputs.version }}
          git push origin ${{ inputs.version }}

      # -----------------------------------------------------
      # ðŸ”¹ Criar Release e anexar artefato (se habilitado)
      # -----------------------------------------------------
      - name: Publish Release
        if: ${{ inputs.publish_release == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version }}
          name: "Lasec HART Communication DTM ${{ inputs.version }}"
          body: |
            **Lasec HART Communication DTM**

            VersÃ£o: ${{ inputs.version }}

            Este release contÃ©m o pacote DTM700 funcional.
          files: |
            artifacts/DTM700/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}