<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

  <Product
      Id="*"
      Name="Lasec HART Communication DTM"
      Language="1033"
      Version="1.0.0.0"
      Manufacturer="JosueLab"
      UpgradeCode="1F6D3983-1B43-4F41-9204-4FAE6E4F0010">

    <Package InstallerVersion="500" Compressed="yes" InstallScope="perMachine" />

    <!-- EMBUTE O CAB DENTRO DO MSI (solução definitiva para cab1.cab) -->
    <MediaTemplate EmbedCab="yes" />

    <!-- ================================================================
         ESTRUTURA DE DIRETÓRIOS
         ================================================================ -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="PACTWARE" Name="PACTware 5.0">
          <Directory Id="DTM700" Name="DTM700">
            <Directory Id="JosueLab" Name="JosueLab">
              <Directory Id="LasecHartCommDTM" Name="LasecHartCommDTM">

                <!-- DeviceTypeCatalog.xml -->
                <Component Id="DeviceTypeCatalogComponent"
                           Guid="C4A111F0-A78C-4320-BBB7-34A93B910011">
                  <File Id="DeviceTypeCatalog"
                        Source="$(var.OutputDir)\DeviceTypeCatalog.xml"
                        KeyPath="yes"/>
                </Component>

                <!-- SUBPASTA /Dtm COM AS DLLs -->
                <Directory Id="DTM" Name="Dtm">
                  <Component Id="DTMFilesComponent"
                             Guid="C4A111F0-A78C-4320-BBB7-34A93B910010">

                    <!-- DTM principal -->
                    <File Id="LasecHartCommDTMFile"
                          Source="$(var.OutputDir)\Dtm\LasecHartCommDTM.dll"
                          KeyPath="yes"/>

                    <!-- Motor de Comunicação -->
                    <File Id="HartEngineFile"
                          Source="$(var.OutputDir)\Dtm\HartEngine.dll"/>

                    <!-- KeyPath auxiliar -->
                    <RegistryValue Root="HKLM"
                                   Key="Software\JosueLab\LasecHartCommDTM"
                                   Name="Installed"
                                   Type="integer"
                                   Value="1"
                                   KeyPath="no"/>
                  </Component>
                </Directory>

              </Directory>
            </Directory>
          </Directory>
        </Directory>
      </Directory>
    </Directory>

    <!-- Agrupamento -->
    <ComponentGroup Id="DTMFiles">
      <ComponentRef Id="DeviceTypeCatalogComponent"/>
      <ComponentRef Id="DTMFilesComponent"/>
    </ComponentGroup>

    <!-- FEATURE PRINCIPAL -->
    <Feature Id="MainFeature"
             Title="Lasec HART Communication DTM"
             Level="1">
      <ComponentGroupRef Id="DTMFiles"/>
    </Feature>


    <!-- ================================================================
         CUSTOM ACTIONS — VERSÃO 64-BIT (regasm correto)
         ================================================================ -->

    <!-- Registrar COM -->
    <CustomAction Id="RegisterDTM"
                  Directory="DTM"
                  Execute="deferred"
                  Impersonate="no"
                  Return="check"
                  ExeCommand='"[WindowsFolder]Microsoft.NET\Framework64\v4.0.30319\regasm.exe" "[#LasecHartCommDTMFile]" /codebase'/>

    <!-- Desregistrar COM -->
    <CustomAction Id="UnregisterDTM"
                  Directory="DTM"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore"
                  ExeCommand='"[WindowsFolder]Microsoft.NET\Framework64\v4.0.30319\regasm.exe" /u "[#LasecHartCommDTMFile]"'/>

    <!-- ORDEM DE EXECUÇÃO -->
    <InstallExecuteSequence>
      <Custom Action="RegisterDTM" After="InstallFiles">NOT Installed</Custom>
      <Custom Action="UnregisterDTM" Before="RemoveFiles">Installed AND NOT UPGRADINGPRODUCTCODE</Custom>
    </InstallExecuteSequence>

  </Product>

</Wix>
